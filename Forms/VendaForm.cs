using System;using System.Collections.Generic;using System.Drawing;using System.Linq;using System.Threading.Tasks;using System.Windows.Forms;using LojaConstrucao.Models;using LojaConstrucao.Data;using LojaConstrucao.Utils;namespace LojaConstrucao.Forms{public partial class VendaForm:Form{private List<Cliente> clientes=new();private List<Produto> produtos=new();private List<ItemVenda> itensVenda=new();private bool isOperating=false;public VendaForm(){InitializeComponent();this.StartPosition=FormStartPosition.CenterScreen;_=CarregarDadosAsync();}private async Task CarregarDadosAsync(){try{clientes=await DatabaseHelper.ListarClientesAsync();cbClientes.Items.Clear();cbClientes.Items.Add("-- Selecione um Cliente --");foreach(var cliente in clientes){cbClientes.Items.Add(cliente.Nome);}cbClientes.SelectedIndex=0;produtos=await DatabaseHelper.ListarProdutosAsync();cbProdutos.Items.Clear();cbProdutos.Items.Add("-- Selecione um Produto --");foreach(var produto in produtos){cbProdutos.Items.Add($"{produto.Nome} - {produto.Preco:C} (Estoque: {produto.Quantidade})");}cbProdutos.SelectedIndex=0;cbFormaPagamento.Items.AddRange(new[]{"Dinheiro","Cartao de Credito","Cartao de Debito","PIX","Cheque"});cbFormaPagamento.SelectedIndex=0;await CarregarVendasAsync();}catch(Exception ex){Logger.LogError("Erro ao carregar dados para venda",ex);MessageBox.Show("Erro ao carregar dados.","Erro",MessageBoxButtons.OK,MessageBoxIcon.Error);}}private void btnAdicionarItem_Click(object sender,EventArgs e){if(cbProdutos.SelectedIndex<=0){MessageBox.Show("Selecione um produto.","Validacao",MessageBoxButtons.OK,MessageBoxIcon.Warning);return;}if(!ValidationHelper.IsValidInteger(txtQuantidade.Text,out int quantidade)||quantidade<=0){MessageBox.Show("Quantidade deve ser um numero positivo.","Validacao",MessageBoxButtons.OK,MessageBoxIcon.Warning);txtQuantidade.Focus();return;}var produtoSelecionado=produtos[cbProdutos.SelectedIndex-1];if(quantidade>produtoSelecionado.Quantidade){MessageBox.Show($"Quantidade indisponivel. Estoque atual: {produtoSelecionado.Quantidade}","Estoque Insuficiente",MessageBoxButtons.OK,MessageBoxIcon.Warning);return;}var itemExistente=itensVenda.FirstOrDefault(i=>i.NomeProduto==produtoSelecionado.Nome);if(itemExistente!=null){itemExistente.Quantidade+=quantidade;}else{itensVenda.Add(new ItemVenda{NomeProduto=produtoSelecionado.Nome,PrecoUnitario=produtoSelecionado.Preco,Quantidade=quantidade});}AtualizarGridItens();LimparCamposItem();}private void btnRemoverItem_Click(object sender,EventArgs e){if(dgvItens.SelectedRows.Count==0){MessageBox.Show("Selecione um item para remover.","Atencao",MessageBoxButtons.OK,MessageBoxIcon.Warning);return;}var index=dgvItens.SelectedRows[0].Index;itensVenda.RemoveAt(index);AtualizarGridItens();}private async void btnRegistrarVenda_Click(object sender,EventArgs e){if(isOperating)return;try{isOperating=true;btnRegistrarVenda.Enabled=false;btnRegistrarVenda.Text="Registrando...";if(!ValidarVenda())return;var clienteSelecionado=cbClientes.SelectedItem.ToString();var produtosStr=string.Join("; ",itensVenda.Select(i=>$"{i.NomeProduto} ({i.Quantidade}x)"));var valorTotal=itensVenda.Sum(i=>i.ValorTotal);var venda=new Venda{Cliente=clienteSelecionado,Produtos=produtosStr,ValorTotal=valorTotal,Data=DateTime.Now,FormaPagamento=cbFormaPagamento.SelectedItem.ToString(),Status="Concluida"};bool sucesso=await DatabaseHelper.RegistrarVendaAsync(venda);if(sucesso){MessageBox.Show($"Venda registrada com sucesso!\n\nCliente: {venda.Cliente}\nValor Total: {venda.ValorTotal:C}\nForma de Pagamento: {venda.FormaPagamento}","Venda Concluida",MessageBoxButtons.OK,MessageBoxIcon.Information);LimparVenda();await CarregarVendasAsync();}else{MessageBox.Show("Erro ao registrar venda. Verifique os logs.","Erro",MessageBoxButtons.OK,MessageBoxIcon.Error);}}catch(Exception ex){Logger.LogError("Erro ao registrar venda via formulario",ex);MessageBox.Show("Erro interno. Operacao cancelada.","Erro",MessageBoxButtons.OK,MessageBoxIcon.Error);}finally{isOperating=false;btnRegistrarVenda.Enabled=true;btnRegistrarVenda.Text="Registrar Venda";}}private async Task CarregarVendasAsync(){try{dgvVendas.Rows.Clear();var vendas=await DatabaseHelper.ListarVendasAsync();foreach(var v in vendas){dgvVendas.Rows.Add(v.Id,v.Cliente,v.ValorTotal.ToString("C"),v.Data.ToString("dd/MM/yyyy HH:mm"),v.FormaPagamento,v.Status);}}catch(Exception ex){Logger.LogError("Erro ao carregar vendas",ex);}}private void AtualizarGridItens(){dgvItens.Rows.Clear();decimal total=0;foreach(var item in itensVenda){dgvItens.Rows.Add(item.NomeProduto,item.Quantidade,item.PrecoUnitario.ToString("C"),item.ValorTotal.ToString("C"));total+=item.ValorTotal;}lblValorTotal.Text=$"Total: {total:C}";}private bool ValidarVenda(){if(cbClientes.SelectedIndex<=0){MessageBox.Show("Selecione um cliente.","Validacao",MessageBoxButtons.OK,MessageBoxIcon.Warning);cbClientes.Focus();return false;}if(itensVenda.Count==0){MessageBox.Show("Adicione pelo menos um produto a venda.","Validacao",MessageBoxButtons.OK,MessageBoxIcon.Warning);return false;}return true;}private void LimparCamposItem(){cbProdutos.SelectedIndex=0;txtQuantidade.Clear();txtQuantidade.Text="1";}private void LimparVenda(){cbClientes.SelectedIndex=0;itensVenda.Clear();AtualizarGridItens();LimparCamposItem();}}partial class VendaForm{private Label lblTitulo,lblCliente,lblProduto,lblQuantidade,lblFormaPagamento,lblValorTotal,lblItens,lblVendas;private ComboBox cbClientes,cbProdutos,cbFormaPagamento;private TextBox txtQuantidade;private Button btnAdicionarItem,btnRemoverItem,btnRegistrarVenda;private DataGridView dgvItens,dgvVendas;private void InitializeComponent(){this.lblTitulo=new Label();this.lblCliente=new Label();this.lblProduto=new Label();this.lblQuantidade=new Label();this.lblFormaPagamento=new Label();this.lblValorTotal=new Label();this.lblItens=new Label();this.lblVendas=new Label();this.cbClientes=new ComboBox();this.cbProdutos=new ComboBox();this.cbFormaPagamento=new ComboBox();this.txtQuantidade=new TextBox();this.btnAdicionarItem=new Button();this.btnRemoverItem=new Button();this.btnRegistrarVenda=new Button();this.dgvItens=new DataGridView();this.dgvVendas=new DataGridView();((System.ComponentModel.ISupportInitialize)(this.dgvItens)).BeginInit();((System.ComponentModel.ISupportInitialize)(this.dgvVendas)).BeginInit();this.lblTitulo.AutoSize=true;this.lblTitulo.Font=new Font("Microsoft Sans Serif",14F,FontStyle.Bold);this.lblTitulo.ForeColor=Color.DarkBlue;this.lblTitulo.Location=new Point(20,20);this.lblTitulo.Text="Sistema de Vendas";this.lblCliente.AutoSize=true;this.lblCliente.Font=new Font("Microsoft Sans Serif",10F,FontStyle.Bold);this.lblCliente.Location=new Point(20,60);this.lblCliente.Text="Cliente:";this.cbClientes.DropDownStyle=ComboBoxStyle.DropDownList;this.cbClientes.Location=new Point(80,57);this.cbClientes.Size=new Size(200,23);this.lblProduto.AutoSize=true;this.lblProduto.Font=new Font("Microsoft Sans Serif",10F,FontStyle.Bold);this.lblProduto.Location=new Point(300,60);this.lblProduto.Text="Produto:";this.cbProdutos.DropDownStyle=ComboBoxStyle.DropDownList;this.cbProdutos.Location=new Point(360,57);this.cbProdutos.Size=new Size(250,23);this.lblQuantidade.AutoSize=true;this.lblQuantidade.Font=new Font("Microsoft Sans Serif",10F,FontStyle.Bold);this.lblQuantidade.Location=new Point(630,60);this.lblQuantidade.Text="Qtd:";this.txtQuantidade.Location=new Point(670,57);this.txtQuantidade.Size=new Size(50,23);this.txtQuantidade.Text="1";this.btnAdicionarItem.BackColor=Color.DarkGreen;this.btnAdicionarItem.ForeColor=Color.White;this.btnAdicionarItem.Location=new Point(20,100);this.btnAdicionarItem.Size=new Size(120,30);this.btnAdicionarItem.Text="Adicionar Item";this.btnAdicionarItem.Click+=new EventHandler(this.btnAdicionarItem_Click);this.btnRemoverItem.BackColor=Color.DarkRed;this.btnRemoverItem.ForeColor=Color.White;this.btnRemoverItem.Location=new Point(150,100);this.btnRemoverItem.Size=new Size(120,30);this.btnRemoverItem.Text="Remover Item";this.btnRemoverItem.Click+=new EventHandler(this.btnRemoverItem_Click);this.lblItens.AutoSize=true;this.lblItens.Font=new Font("Microsoft Sans Serif",10F,FontStyle.Bold);this.lblItens.Location=new Point(20,150);this.lblItens.Text="Itens da Venda:";this.dgvItens.AllowUserToAddRows=false;this.dgvItens.AllowUserToDeleteRows=false;this.dgvItens.AutoSizeColumnsMode=DataGridViewAutoSizeColumnsMode.Fill;this.dgvItens.Location=new Point(20,175);this.dgvItens.ReadOnly=true;this.dgvItens.SelectionMode=DataGridViewSelectionMode.FullRowSelect;this.dgvItens.Size=new Size(700,150);this.dgvItens.ColumnCount=4;this.dgvItens.Columns[0].Name="Produto";this.dgvItens.Columns[0].HeaderText="Produto";this.dgvItens.Columns[1].Name="Quantidade";this.dgvItens.Columns[1].HeaderText="Quantidade";this.dgvItens.Columns[1].Width=100;this.dgvItens.Columns[2].Name="PrecoUnitario";this.dgvItens.Columns[2].HeaderText="Preco Unit.";this.dgvItens.Columns[2].Width=100;this.dgvItens.Columns[3].Name="Total";this.dgvItens.Columns[3].HeaderText="Total";this.dgvItens.Columns[3].Width=100;this.lblValorTotal.AutoSize=true;this.lblValorTotal.Font=new Font("Microsoft Sans Serif",12F,FontStyle.Bold);this.lblValorTotal.ForeColor=Color.DarkGreen;this.lblValorTotal.Location=new Point(20,340);this.lblValorTotal.Text="Total: R$ 0,00";this.lblFormaPagamento.AutoSize=true;this.lblFormaPagamento.Font=new Font("Microsoft Sans Serif",10F,FontStyle.Bold);this.lblFormaPagamento.Location=new Point(200,342);this.lblFormaPagamento.Text="Forma Pagamento:";this.cbFormaPagamento.DropDownStyle=ComboBoxStyle.DropDownList;this.cbFormaPagamento.Location=new Point(330,339);this.cbFormaPagamento.Size=new Size(150,23);this.btnRegistrarVenda.BackColor=Color.DarkOrange;this.btnRegistrarVenda.ForeColor=Color.White;this.btnRegistrarVenda.Location=new Point(500,335);this.btnRegistrarVenda.Size=new Size(150,35);this.btnRegistrarVenda.Text="Registrar Venda";this.btnRegistrarVenda.Font=new Font("Microsoft Sans Serif",10F,FontStyle.Bold);this.btnRegistrarVenda.Click+=new EventHandler(this.btnRegistrarVenda_Click);this.lblVendas.AutoSize=true;this.lblVendas.Font=new Font("Microsoft Sans Serif",10F,FontStyle.Bold);this.lblVendas.Location=new Point(20,390);this.lblVendas.Text="Vendas Realizadas:";this.dgvVendas.AllowUserToAddRows=false;this.dgvVendas.AllowUserToDeleteRows=false;this.dgvVendas.AutoSizeColumnsMode=DataGridViewAutoSizeColumnsMode.Fill;this.dgvVendas.Location=new Point(20,415);this.dgvVendas.ReadOnly=true;this.dgvVendas.SelectionMode=DataGridViewSelectionMode.FullRowSelect;this.dgvVendas.Size=new Size(700,200);this.dgvVendas.ColumnCount=6;this.dgvVendas.Columns[0].Name="Id";this.dgvVendas.Columns[0].HeaderText="ID";this.dgvVendas.Columns[0].Width=50;this.dgvVendas.Columns[1].Name="Cliente";this.dgvVendas.Columns[1].HeaderText="Cliente";this.dgvVendas.Columns[2].Name="Valor";this.dgvVendas.Columns[2].HeaderText="Valor";this.dgvVendas.Columns[2].Width=100;this.dgvVendas.Columns[3].Name="Data";this.dgvVendas.Columns[3].HeaderText="Data";this.dgvVendas.Columns[3].Width=120;this.dgvVendas.Columns[4].Name="Pagamento";this.dgvVendas.Columns[4].HeaderText="Pagamento";this.dgvVendas.Columns[4].Width=120;this.dgvVendas.Columns[5].Name="Status";this.dgvVendas.Columns[5].HeaderText="Status";this.dgvVendas.Columns[5].Width=80;this.ClientSize=new Size(750,640);this.Controls.Add(this.lblTitulo);this.Controls.Add(this.lblCliente);this.Controls.Add(this.cbClientes);this.Controls.Add(this.lblProduto);this.Controls.Add(this.cbProdutos);this.Controls.Add(this.lblQuantidade);this.Controls.Add(this.txtQuantidade);this.Controls.Add(this.btnAdicionarItem);this.Controls.Add(this.btnRemoverItem);this.Controls.Add(this.lblItens);this.Controls.Add(this.dgvItens);this.Controls.Add(this.lblValorTotal);this.Controls.Add(this.lblFormaPagamento);this.Controls.Add(this.cbFormaPagamento);this.Controls.Add(this.btnRegistrarVenda);this.Controls.Add(this.lblVendas);this.Controls.Add(this.dgvVendas);this.Text="Sistema de Vendas";this.BackColor=Color.WhiteSmoke;((System.ComponentModel.ISupportInitialize)(this.dgvItens)).EndInit();((System.ComponentModel.ISupportInitialize)(this.dgvVendas)).EndInit();}}}